@page "/invite-token"
@using System.Net.Http.Json
@inject HttpClient Http
@inject IEndpointState Endpoint

<PageTitle>Invite Token</PageTitle>

<h1>Invite Token</h1>

@if (Http.BaseAddress == null)
{
    <p>Please verify a WordPress endpoint on the <NavLink href="/">Home</NavLink> page first.</p>
}
else
{
    <button class="btn btn-primary" @onclick="GenerateTokenAsync">Generate Token</button>

    @if (responseJson != null)
    {
        <div class="mt-3">
            <strong>Token:</strong>
            <pre class="json-view">@responseJson</pre>
        </div>
    }
    @if (!string.IsNullOrEmpty(error))
    {
        <p class="text-danger mt-2">@error</p>
    }
}

@code {
    private string? responseJson;
    private string? error;

    protected override void OnInitialized()
    {
        Endpoint.Changed += () => Http.BaseAddress = Endpoint.BaseAddress;
        Http.BaseAddress = Endpoint.BaseAddress;
    }

    private async Task GenerateTokenAsync()
    {
        responseJson = null;
        error = null;
        try
        {
            using var resp = await Http.PostAsync("invite/v1/token", null);
            var json = await resp.Content.ReadAsStringAsync();
            if (resp.IsSuccessStatusCode)
            {
                responseJson = JsonDocument
  .Parse(json)
  .RootElement
  .GetRawText();
            }
            else
            {
                error = json;
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }
}
