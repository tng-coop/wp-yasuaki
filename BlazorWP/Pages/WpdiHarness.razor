@page "/wpdi-harness"
@using System.Net.Http.Json
@using Editor.Abstractions
@using Editor.WordPress
@inject IPostEditor Editor
@inject IPostFeed Feed
@inject IWordPressApiService Api

<PageTitle>WPDI Harness</PageTitle>

<!--
  Minimal, deterministic harness around WPDI (Editor/Feed) to support e2e.
  - Surface: create / list / update-content (LWW) / status / delete
  - WPDI for create/update/delete; IPostFeed for listing; raw REST for status
  - Stable data-testid hooks + data-post-id rows + per-cell testids
-->

<section class="container py-3" data-testid="wpdi-harness">
  <h3 class="mb-3">WPDI Test Harness</h3>

  <div class="row g-2 align-items-end mb-2">
    <div class="col-sm-6">
      <label for="title" class="form-label">Title</label>
      <input id="title" class="form-control" placeholder="Post title" @bind="Title" data-testid="title-input" />
    </div>
    <div class="col-sm-3">
      <label for="postId" class="form-label">Id</label>
      <input id="postId" class="form-control" placeholder="Id" @bind="IdText" data-testid="id-input" />
    </div>
    <div class="col-sm-3 d-flex gap-2 flex-wrap">
      <button class="btn btn-primary" data-testid="btn-create" @onclick="CreateDraft">Create Draft</button>
      <button class="btn btn-outline-secondary" data-testid="btn-update-content" @onclick="UpdateContent">Update Content</button>
    </div>
  </div>

  <div class="d-flex flex-wrap gap-2 mb-2">
    <button class="btn btn-outline-primary" data-testid="btn-list" @onclick="List">List</button>
    <button class="btn btn-outline-warning" data-testid="btn-submit" @onclick="() => ChangeStatus(\"pending\")">Submit for Review</button>
    <button class="btn btn-outline-dark" data-testid="btn-retract" @onclick="() => ChangeStatus(\"draft\")">Retract to Draft</button>
    <button class="btn btn-success" data-testid="btn-publish" @onclick="() => ChangeStatus(\"publish\")">Publish</button>
    <button class="btn btn-danger" data-testid="btn-delete" @onclick="Delete">Delete (force)</button>
  </div>

  <div role="status" class="mb-2" data-testid="status">@Status</div>

  <div class="table-responsive" style="max-height: 320px; overflow:auto;">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th>Id</th>
          <th>Title</th>
          <th>Status</th>
          <th>Modified (GMT)</th>
        </tr>
      </thead>
      <tbody data-testid="post-table">
        @foreach (var p in Items)
        {
          <tr class="@(p.Id == CurrentId ? "table-primary" : null)"
              @onclick="() => Select(p)"
              data-post-id="@p.Id">
            <td data-testid="cell-id">@p.Id</td>
            <td data-testid="cell-title">@p.Title</td>
            <td data-testid="cell-status">@p.Status</td>
            <td data-testid="cell-modified">@p.ModifiedGmt</td>
          </tr>
        }
      </tbody>
    </table>
  </div>
</section>

@code {
  private const string RestBase = "posts";

  private string Title = string.Empty;
  private string IdText = string.Empty;
  private string Status = "Ready.";
  private long? CurrentId => long.TryParse(IdText, out var v) ? v : (long?)null;

  private List<PostSummary> Items = new();

  private async Task CreateDraft()
  {
    try
    {
      var t = string.IsNullOrWhiteSpace(Title) ? $"Harness {DateTimeOffset.UtcNow:yyyyMMdd-HHmmss}" : Title;
      var res = await Editor.CreateAsync(t, "<p>wpdi harness</p>");
      IdText = res.Id.ToString();
      Status = $"Draft created: {res.Id}";
      await List();
    }
    catch (Exception ex)
    {
      Status = $"Create failed: {ex.Message}";
    }
  }

  private async Task UpdateContent()
  {
    if (CurrentId is null) { Status = "Enter Id"; return; }
    try
    {
      // Honor LWW: fetch current modified_gmt before update
      var http = Api.HttpClient;
      if (http is null) { Status = "API client unavailable"; return; }

      var get = await http.GetFromJsonAsync<System.Text.Json.JsonElement>($"/wp-json/wp/v2/posts/{CurrentId}?context=edit");
      var lastSeen = get.TryGetProperty("modified_gmt", out var mg) ? (mg.GetString() ?? "") : "";
      if (string.IsNullOrWhiteSpace(lastSeen)) { Status = "Could not read modified_gmt"; return; }

      var html = $"<p>updated @ {DateTime.UtcNow:O}</p>";
      var result = await Editor.UpdateAsync(CurrentId.Value, html, lastSeen);
      Status = $"Content updated (Id {result.Id})";
      await List();
    }
    catch (Exception ex)
    {
      Status = $"Update failed: {ex.Message}";
    }
  }

  private async Task ChangeStatus(string newStatus)
  {
    if (CurrentId is null) { Status = "Enter Id"; return; }
    try
    {
      // Status transitions still use REST for now
      var http = Api.HttpClient;
      if (http is null) { Status = "API client unavailable"; return; }
      var resp = await http.PostAsJsonAsync($"/wp-json/wp/v2/posts/{CurrentId}", new { status = newStatus });
      resp.EnsureSuccessStatusCode();
      Status = $"Status → {newStatus}";
      await List();
    }
    catch (Exception ex)
    {
      Status = $"Status change failed: {ex.Message}";
    }
  }

  // ✅ Delete: WPDI + optimistic eviction + background refresh
  private async Task Delete()
  {
    if (CurrentId is null) { Status = "Enter Id"; return; }

    var id = CurrentId.Value;

    try
    {
      // 1) Server delete via WPDI (idempotent: 200/404/410 => success)
      await Editor.DeleteAsync(id, force: true);
      Status = "Deleted (server acknowledged)";

      // 2) Optimistic local eviction: remove from in-memory snapshot and notify subscribers immediately
      Feed.Evict(RestBase, id);

      // 3) Kick off standard refresh to reconcile with server (first N, then page M-by-M)
      _ = Feed.RefreshAsync(RestBase);

      // 4) Update UI list from current snapshot (instant)
      Items = Feed.Current(RestBase).OrderByDescending(p => p.ModifiedGmt).ToList();
    }
    catch (Exception ex)
    {
      Status = $"Delete failed: {ex.Message}";
    }
  }

  private async Task List()
  {
    try
    {
      await Feed.RefreshAsync(RestBase);
      Items = Feed.Current(RestBase).OrderByDescending(p => p.ModifiedGmt).ToList();
      Status = $"Listed {Items.Count} items";
    }
    catch (Exception ex)
    {
      Status = $"List failed: {ex.Message}";
    }
  }

  private void Select(PostSummary p)
  {
    IdText = p.Id.ToString();
    Title = p.Title;
  }
}
