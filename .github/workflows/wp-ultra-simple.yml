name: WP Ultra Simple CI

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  wp:
    runs-on: ubuntu-latest

    services:
      db:
        image: mariadb:11
        env:
          MARIADB_DATABASE: wordpress
          MARIADB_USER: wp
          MARIADB_PASSWORD: wp
          MARIADB_ROOT_PASSWORD: root
        # expose DB to the job on localhost:3306
        ports:
          - 3306:3306
        # ❌ no healthcheck — avoid flaky “unhealthy”/init loops on runners

    steps:
      - uses: actions/checkout@v4

      - name: PHP 8.3
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mysqli, curl, mbstring, xml, zip, gd

      - name: Install WP-CLI
        run: |
          curl -fsSL -o wp https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
          chmod +x wp
          sudo mv wp /usr/local/bin/wp

      - name: Download WordPress
        run: wp core download --path=wordpress

      - name: Create wp-config.php
        run: |
          wp config create --path=wordpress \
            --dbname=wordpress --dbuser=wp --dbpass=wp --dbhost=127.0.0.1

      - name: Wait for DB (retry)
        run: |
          for i in {1..90}; do
            wp db check --path=wordpress && break || sleep 2
          done

      - name: Install WordPress
        run: |
          wp core install --path=wordpress \
            --url="http://127.0.0.1:8081" \
            --title="CI Test Site" \
            --admin_user=admin \
            --admin_password=ChangeMe! \
            --admin_email=admin@example.com

      - name: Start PHP server
        run: |
          nohup php -S 127.0.0.1:8081 -t wordpress >/dev/null 2>&1 &

      - name: Create CI user + App Password
        id: app
        run: |
          wp user get ci-poster --field=ID --path=wordpress >/dev/null 2>&1 || \
          wp user create ci-poster ci-poster@example.com --role=author --user_pass="$(openssl rand -base64 18)" --path=wordpress
          APP=$(wp user application-password create ci-poster gha --porcelain --path=wordpress || true)
          if [ -z "$APP" ]; then
            APP=$(wp user application-password list ci-poster --format=csv --path=wordpress | tail -n 1 | cut -d, -f1)
          fi
          echo "wp_base_url=http://127.0.0.1:8081" >> "$GITHUB_OUTPUT"
          echo "wp_user=ci-poster" >> "$GITHUB_OUTPUT"
          echo "wp_app_password=$APP" >> "$GITHUB_OUTPUT"

      - name: Smoke post via REST
        env:
          WP_BASE_URL: ${{ steps.app.outputs.wp_base_url }}
          WP_USER: ${{ steps.app.outputs.wp_user }}
          WP_APP_PASSWORD: ${{ steps.app.outputs.wp_app_password }}
        run: |
          curl -f -sS -X POST "$WP_BASE_URL/wp-json/wp/v2/posts" \
            -u "$WP_USER:$WP_APP_PASSWORD" \
            -H "Content-Type: application/json" \
            -d '{"title":"Hello from CI","status":"publish","content":"<p>It works 🎉</p>"}' \
          | jq .
