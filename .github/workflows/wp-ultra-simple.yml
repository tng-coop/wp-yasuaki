name: WP Ultra Simple CI (clean slate, no --force)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  wp:
    runs-on: ubuntu-latest

    services:
      db:
        image: mariadb:11
        env:
          MARIADB_DATABASE: wordpress
          MARIADB_USER: wp
          MARIADB_PASSWORD: wp
          MARIADB_ROOT_PASSWORD: root
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mariadb-admin ping -h 127.0.0.1 --protocol=tcp -uroot -proot --connect-timeout=2 --silent"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=60
          --health-start-period=40s

    steps:
      - uses: actions/checkout@v4

      - name: Install PHP 8.3 + extensions
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mysqli, curl, mbstring, xml, zip, gd

      - name: Install WP-CLI
        run: |
          sudo wget -qO /usr/local/bin/wp https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
          sudo chmod +x /usr/local/bin/wp
          wp --info

      # --- NEW: prerequisites for generate-ca-and-certs (certutil, CA tools) ---
      - name: Install NSS tools (certutil) + CA utilities
        run: |
          sudo apt-get update -y
          sudo apt-get install -y libnss3-tools ca-certificates

      - name: Create workspace
        run: mkdir -p wordpress

      - name: Download WordPress
        run: wp core download --path=wordpress

      - name: Wait for database readiness (runner-side)
        run: |
          for i in {1..180}; do
            mysqladmin ping -h127.0.0.1 -uwp -pwp --protocol=tcp --silent && exit 0
            sleep 2
          done
          echo "Database did not become ready in time." >&2
          exit 1

      - name: Create wp-config.php
        run: |
          wp config create --path=wordpress \
            --dbname=wordpress --dbuser=wp --dbpass=wp --dbhost=127.0.0.1

      - name: Enable WP debug (log to file, no HTML fatals)
        run: |
          wp config set WP_DEBUG true --path=wordpress --type=constant --raw
          wp config set WP_DEBUG_LOG true --path=wordpress --type=constant --raw
          wp config set WP_DEBUG_DISPLAY false --path=wordpress --type=constant --raw
          wp config set WP_DISABLE_FATAL_ERROR_HANDLER true --path=wordpress --type=constant --raw

      - name: Install WordPress
        run: |
          wp core install --path=wordpress \
            --url="https://aspnet.lan:8443" \
            --title="CI Test Site" \
            --admin_user=admin \
            --admin_password=ChangeMe! \
            --admin_email=admin@example.com


      - name: Start PHP development server (cd into wordpress)
        run: |
          cd wordpress
          nohup php -d display_errors=1 -S 127.0.0.1:8081 index.php > ../server.log 2>&1 &

      - name: Create CI users + Application Passwords
        id: app
        run: |
          set -euo pipefail
          wp user create ci-poster ci-poster@example.com --role=author --user_pass="$(openssl rand -base64 18)" --path=wordpress
          CI_APP=$(wp user application-password create ci-poster gha --porcelain --path=wordpress)
          # admin for tests
          ADMIN_APP=$(wp user application-password create admin gha --porcelain --path=wordpress)
          {
            echo "wp_base_url=https://aspnet.lan:8443"
            echo "wp_user=ci-poster"
            echo "wp_app_password=$CI_APP"
            echo "wp_admin_user=admin"
            echo "wp_admin_app_password=$ADMIN_APP"
          } >> "$GITHUB_OUTPUT"


      - name: WP REST sanity (CLI, bypass HTTP)
        run: |
          echo "=== REST status via WP-CLI ==="
          wp eval '
            $r = rest_do_request( new WP_REST_Request("GET","/") );
            echo "status=" . $r->get_status() . PHP_EOL;
            if ($r->is_error()) { $e = $r->as_error(); echo $e->get_error_message() . PHP_EOL; }
          ' --path=wordpress

      - name: Diagnostics (dump WP state)
        run: |
          set -e
          echo "=== PHP version ==="; php -v
          echo "=== WP version ==="; wp core version --path=wordpress
          echo "=== Users ==="; wp user list --path=wordpress --fields=ID,user_login,user_email,roles
          echo "=== Active theme ==="; wp theme list --path=wordpress --status=active
          echo "=== Plugins ==="; wp plugin list --path=wordpress || true
          echo "=== DB check ==="; wp db check --path=wordpress

          echo "=== Site root (curl HEAD) ==="
          curl -s -I http://127.0.0.1:8081/ | head -n 20

          echo "=== REST index (non-pretty) ==="
          URL='http://127.0.0.1:8081/index.php?rest_route=/'
          if ! curl -fsS -D /tmp/rest.h -H 'Accept: application/json' "$URL" -o /tmp/rest.json; then
            echo ">>> PHP built-in server log:"; tail -n +1 server.log || true
            echo ">>> wp-content/debug.log:"; tail -n +1 wordpress/wp-content/debug.log || true
            exit 1
          fi
          grep -i '^content-type:' /tmp/rest.h || true
          jq -e . /tmp/rest.json > /dev/null && jq . /tmp/rest.json

      # Generate a local CA + leaf certs (iOS/macOS compatible SANs)
      - name: Generate CA and certs
        shell: bash
        run: |
          set -euxo pipefail
          chmod +x BlazorWP/scripts/generate-ca-and-certs.sh
          bash BlazorWP/scripts/generate-ca-and-certs.sh
          echo "--- Generated cert artifacts (BlazorWP/cert) ---"
          ls -la BlazorWP/cert || true
          echo "--- Shared publish dir (/srv/shared/aspnet/cert) ---"
          sudo ls -la /srv/shared/aspnet/cert || true

          # bring shared dir into workspace so upload-artifact can access without absolute path
          sudo cp -r /srv/shared/aspnet/cert BlazorWP/cert/_shared
          sudo chown -R "$USER":"$USER" BlazorWP/cert/_shared
          find BlazorWP/cert/_shared -type d -print0 | xargs -0 chmod u+rwx,go+rx
          find BlazorWP/cert/_shared -type f -print0 | xargs -0 chmod u+rw,go+r

      - name: Setup Apache SSL proxy (aspnet.lan â†’ PHP server)
        shell: bash
        env:
          DOMAIN: aspnet.lan
          BACKEND: http://127.0.0.1:8081
          LISTEN_PORT: '8443'
          SRC_CERT_DIR: BlazorWP/cert/_shared
        run: |
          set -euxo pipefail
          chmod +x BlazorWP/scripts/setup-apache-ssl-proxy.sh
          BlazorWP/scripts/setup-apache-ssl-proxy.sh

      - name: HTTPS smoke test (Apache TLS â†’ WordPress)
        run: |
          set -euxo pipefail
          curl -I https://aspnet.lan:8443/
          curl -fsS https://aspnet.lan:8443/ -o /tmp/index.html
          head -n 20 /tmp/index.html

      - name: Verify REST pretty route works
        run: |
          set -euxo pipefail
          curl -fsSI https://aspnet.lan:8443/wp-json/
          curl -fsS  https://aspnet.lan:8443/wp-json/wp/v2 | jq '.namespace'

      - name: Upload cert artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aspnet-dev-certs
          path: |
            BlazorWP/cert/**
          if-no-files-found: warn
          retention-days: 7

      - name: REST smoke test (create a post, non-pretty route)
        env:
          WP_BASE_URL: ${{ steps.app.outputs.wp_base_url }}
          WP_USER: ${{ steps.app.outputs.wp_user }}
          WP_APP_PASSWORD: ${{ steps.app.outputs.wp_app_password }}
        run: |
          set -e
          curl -fsS -X POST "$WP_BASE_URL/index.php?rest_route=/wp/v2/posts" \
            -u "$WP_USER:$WP_APP_PASSWORD" \
            -H "Content-Type: application/json" \
            -d '{"title":"Hello from CI","status":"publish","content":"<p>It works ðŸŽ‰</p>"}' \
          | jq .

      - name: Assert REST endpoints (canonical vs variants)
        run: |
          set -euxo pipefail
          BASE="https://aspnet.lan:8443"
          ADMIN_USER="${{ steps.app.outputs.wp_admin_user }}"
          ADMIN_APP="${{ steps.app.outputs.wp_admin_app_password }}"

          get_code() { curl -sS -o /dev/null -w '%{http_code}' "$@"; }  # note: no -f

          echo "A) Settings (no slash) â€” expect 301"
          code=$(get_code -I "$BASE/wp-json/wp/v2/settings")
          test "$code" = "301"

          echo "B) Settings (trailing slash) â€” expect 200"
          code=$(get_code -u "$ADMIN_USER:$ADMIN_APP" "$BASE/wp-json/wp/v2/settings/")
          test "$code" = "200"

          echo "C) Me (trailing slash) â€” expect 200"
          code=$(get_code -u "$ADMIN_USER:$ADMIN_APP" "$BASE/wp-json/wp/v2/users/me/")
          test "$code" = "200"


      # ----- .NET: plain runner, user-local install (no sudo in action) -----

      - name: Prepare dotnet install dir (user-local)
        run: |
          echo "DOTNET_INSTALL_DIR=$HOME/.dotnet" >> "$GITHUB_ENV"
          echo "DOTNET_ROOT=" >> "$GITHUB_ENV"

      - name: Setup .NET 9 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Verify dotnet
        run: dotnet --info

      - name: Make gen-appsettings.sh executable
        run: chmod +x scripts/gen-appsettings.sh

      - name: Generate appsettings (plain files)
        shell: bash
        env:
          WP_BASE_URL: ${{ steps.app.outputs.wp_base_url }}
        run: |
          set -euxo pipefail
          bash -x ./scripts/gen-appsettings.sh

      - name: Postflight FS check (after gen-appsettings)
        if: always()
        run: |
          set -euxo pipefail
          echo "--- BlazorWP root ---"
          ls -la BlazorWP || true
          echo "--- wwwroot ---"
          ls -la BlazorWP/wwwroot || true
          echo "--- appsettings.json ---"
          sed -n '1,120p' BlazorWP/wwwroot/appsettings.json || true
          echo "--- appsettings.Development.json ---"
          sed -n '1,120p' BlazorWP/appsettings.Development.json || true
          echo "--- Server log (if any) ---"
          tail -n +1 server.log || true
          echo "--- PHP debug.log (if any) ---"
          tail -n +1 wordpress/wp-content/debug.log || true

      - name: Restore
        run: dotnet restore Workspace.sln

      - name: Build (Release)
        run: dotnet build Workspace.sln -c Release --no-restore

      - name: Run all tests (Workspace.sln)
        env:
          # âœ… point tests at Apache (pretty routes work)
          WP_BASE_URL: https://aspnet.lan:8443
          WordPress__Url: https://aspnet.lan:8443
          WP_USER: ${{ steps.app.outputs.wp_admin_user }}
          WP_USERNAME: ${{ steps.app.outputs.wp_admin_user }}
          WP_APP_PASSWORD: ${{ steps.app.outputs.wp_admin_app_password }}
          DOTNET_ENVIRONMENT: Development
          DOTNET_CLI_TELEMETRY_OPTOUT: 1
        run: dotnet test Workspace.sln -c Release --no-build --no-restore -m:1

      - name: Run E2E/Integration tests (if any)
        if: ${{ hashFiles('BlazorWP.E2E/*.csproj') != '' }}
        env:
          WP_BASE_URL: https://aspnet.lan:8443
          WordPress__Url: https://aspnet.lan:8443
          WP_USER: ${{ steps.app.outputs.wp_admin_user }}
          WP_USERNAME: ${{ steps.app.outputs.wp_admin_user }}
          WP_APP_PASSWORD: ${{ steps.app.outputs.wp_admin_app_password }}
          DOTNET_ENVIRONMENT: Development
          DOTNET_CLI_TELEMETRY_OPTOUT: 1
        run: dotnet test BlazorWP.E2E/BlazorWP.E2E.csproj -c Release --no-build --no-restore --logger "trx;LogFileName=e2e.trx"
