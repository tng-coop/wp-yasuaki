<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bible Reader with TTS</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>
<body>
  <div class="container py-5">
    <h1 class="mb-4">Bible Reader</h1>
    <div class="mb-3">
      <label for="lang-select" class="form-label">Language:</label>
      <select id="lang-select" class="form-select w-auto d-inline-block">
        <option value="en" selected>English</option>
        <option value="jp">日本語</option>
      </select>
    </div>
    <p id="verse" class="lead">Loading verse...</p>
    <button id="new-verse" class="btn btn-primary mb-4">New Verse</button>
  </div>

  <script type="module" defer>
    // --- Imports ---
    import bibleQuotes from 'https://esm.sh/bible-quotes';

    // --- Globals & UI refs ---
    const verseEl     = document.getElementById('verse');
    const newVerseBtn = document.getElementById('new-verse');
    const langSelect  = document.getElementById('lang-select');

    // English setup
    const enMethods = Object.keys(bibleQuotes).filter(k => typeof bibleQuotes[k] === 'function');
    let enCurrentText = '';

    // Japanese setup
    const OSIS_URL = 'https://raw.githubusercontent.com/seven1m/open-bibles/master/jpn-kougo.osis.xml';
    let jpVerses = [];

    // --- Helpers ---
    function abortTTS() {
      if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
      }
    }

    function getPreferredVoice(lang) {
      const voices = window.speechSynthesis?.getVoices?.() ?? [];
      if (!voices.length) return null;

      if (lang === 'jp') {
        const jpExact = voices.find(v => v.lang?.toLowerCase().startsWith('ja-jp'));
        if (jpExact) return jpExact;
        const anyJa = voices.find(v => v.lang?.toLowerCase().startsWith('ja'));
        if (anyJa) return anyJa;
      } else {
        const enUS = voices.find(v => v.lang?.toLowerCase().startsWith('en-us'));
        if (enUS) return enUS;
        const anyEn = voices.find(v => v.lang?.toLowerCase().startsWith('en'));
        if (anyEn) return anyEn;
      }
      return voices[0] ?? null;
    }

    function speak(text, lang) {
      abortTTS();
      if (!('speechSynthesis' in window)) {
        console.warn('SpeechSynthesis not supported in this browser.');
        return;
      }
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = (lang === 'jp') ? 'ja-JP' : 'en-US';

      const assignAndSpeak = () => {
        const voice = getPreferredVoice(lang);
        if (voice) utter.voice = voice;
        utter.rate   = 1.0;
        utter.pitch  = 1.0;
        utter.volume = 1.0;
        window.speechSynthesis.speak(utter);
      };

      const voices = window.speechSynthesis.getVoices();
      if (!voices || voices.length === 0) {
        const once = () => {
          window.speechSynthesis.removeEventListener('voiceschanged', once);
          assignAndSpeak();
        };
        window.speechSynthesis.addEventListener('voiceschanged', once);
        window.speechSynthesis.getVoices();
      } else {
        assignAndSpeak();
      }
    }

    // --- English verse fetcher ---
    async function fetchEN() {
      const fn     = bibleQuotes[enMethods[0]];
      const result = await fn();
      enCurrentText = typeof result === 'string' ? result : JSON.stringify(result, null, 2);
      return enCurrentText;
    }

    // --- Japanese loader & picker ---
    async function loadJP() {
      if (jpVerses.length) return;
      const res     = await fetch(OSIS_URL);
      const xmlText = await res.text();
      const xmlDoc  = new DOMParser().parseFromString(xmlText, 'application/xml');
      const nodes   = Array.from(xmlDoc.getElementsByTagName('verse'));
      jpVerses = nodes
        .map(n => ({ id: n.getAttribute('osisID'), text: n.textContent.trim() }))
        .filter(v => v.id && v.text);
    }
    function pickJP() {
      const idx = Math.floor(Math.random() * jpVerses.length);
      return jpVerses[idx];
    }

    // --- Main handler ---
    newVerseBtn.addEventListener('click', async () => {
      const lang = langSelect.value;
      verseEl.textContent = lang === 'jp' ? '読み込んでいます…' : 'Loading verse...';

      try {
        if (lang === 'jp') {
          await loadJP();
          if (!jpVerses.length) throw new Error('No Japanese verses');
          const { id, text } = pickJP();
          verseEl.textContent = `${id}　${text}`;
          speak(text, 'jp');
        } else {
          const text = await fetchEN();
          verseEl.textContent = text;
          speak(text, 'en');
        }
      } catch (err) {
        console.error(err);
        verseEl.textContent = lang === 'jp'
          ? '読み込みエラーが発生しました'
          : 'Failed to load verse.';
      }
    });

    // Initial call
    newVerseBtn.click();
  </script>
</body>
</html>
