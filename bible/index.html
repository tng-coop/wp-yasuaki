<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bible Reader with TTS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    code.small { font-size:.85em }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <h1 class="mb-0">Bible Reader</h1>
      <div id="status" class="text-muted small"></div>
    </div>
    <hr class="my-3"/>

    <div class="d-flex align-items-end gap-3 mb-3 flex-wrap">
      <div>
        <label for="lang-select" class="form-label">Edition:</label>
        <select id="lang-select" class="form-select w-auto d-inline-block">
          <option value="en" selected>English (prefer eBible KJVD)</option>
          <option value="jp">日本語（口語訳）</option>
        </select>
      </div>

      <div class="d-flex gap-2">
        <button id="random-verse" class="btn btn-primary">Get New Verse</button>
        <button id="stop-tts" class="btn btn-outline-secondary">Stop TTS</button>
      </div>

      <!-- Optional: manual override for English source -->
      <div class="ms-auto d-flex align-items-end gap-2" style="min-width:320px">
        <div class="flex-grow-1">
          <label class="form-label mb-1" for="custom-en-url">Custom English OSIS URL (eBible)</label>
          <input id="custom-en-url" class="form-control form-control-sm" placeholder="https://ebible.org/Scriptures/eng-... .osis.xml" />
        </div>
        <button id="use-custom-en" class="btn btn-sm btn-outline-secondary">Use</button>
      </div>
    </div>

    <!-- Verse Selection UI -->
    <div class="card mb-3">
      <div class="card-body d-flex flex-wrap align-items-end gap-2">
        <div>
          <label for="book-select" class="form-label mb-1">Book</label>
          <select id="book-select" class="form-select" disabled></select>
        </div>
        <div>
          <label for="chapter-select" class="form-label mb-1">Chapter</label>
          <select id="chapter-select" class="form-select" disabled></select>
        </div>
        <div>
          <label for="verse-select" class="form-label mb-1">Verse</label>
          <select id="verse-select" class="form-select" disabled></select>
        </div>

        <button id="go-verse" class="btn btn-success" disabled>Read Selected</button>
        <button id="next-verse" class="btn btn-warning" disabled>Keep Reading ▶</button>

        <div class="ms-auto d-flex align-items-end gap-2 flex-grow-1" style="min-width:280px">
          <div class="flex-grow-1">
            <label for="ref-input" class="form-label mb-1">Reference (e.g., Sirach 2:1 / ヨハネ 3:16)</label>
            <input id="ref-input" class="form-control" placeholder="Book Chapter:Verse" />
          </div>
          <button id="go-ref" class="btn btn-outline-primary">Go</button>
        </div>
      </div>
    </div>

    <!-- Auto-Play Controls -->
    <div class="card mb-3">
      <div class="card-body d-flex align-items-center gap-3 flex-wrap">
        <button id="auto-toggle" class="btn btn-outline-success" disabled>Auto-Play ▶</button>
        <button id="auto-pause" class="btn btn-outline-warning" disabled>Pause ⏸</button>
        <div class="d-flex align-items-center gap-2">
          <label for="rate" class="form-label mb-0">Speed</label>
          <input id="rate" type="range" class="form-range" min="0.5" max="2" step="0.1" value="1" style="width:180px" />
          <span id="rate-val" class="text-muted">1.0×</span>
        </div>
      </div>
    </div>

    <p id="verse" class="lead">Choose an edition and press "Get New Verse"</p>
    <small id="source" class="text-muted d-block"></small>
  </div>

  <script type="module" defer>
    // --- Candidate URLs ---
    // These are the most common direct OSIS endpoints used on eBible.
    // We probe with GET (not HEAD) because some origins reject HEAD.
    const EBIBLE_CANDIDATES_KJVD = [
      'https://ebible.org/Scriptures/eng-kjvd.osis.xml',
      'https://ebible.org/Scriptures/eng-kjva.osis.xml',
      'https://ebible.org/osis/eng-kjvd.osis.xml'
    ];
    const EBIBLE_KJV_OSIS = [
      'https://ebible.org/Scriptures/eng-kjv.osis.xml',
      'https://ebible.org/osis/eng-kjv.osis.xml'
    ];
    const LAST_RESORT_KJV = 'https://raw.githubusercontent.com/seven1m/open-bibles/master/eng-kjv.osis.xml';

    const SOURCES = {
      en: { url: null, ttsLang: 'en-US', loading: 'Loading verse...', error: 'Failed to load verse.', label: 'English (auto: eBible KJVD → KJV)' },
      jp: { url: 'https://raw.githubusercontent.com/seven1m/open-bibles/master/jpn-kougo.osis.xml', ttsLang: 'ja-JP', loading: '読み込んでいます…', error: '読み込みエラーが発生しました', label: '口語訳聖書' }
    };

    // Canonical OSIS order (73-book list; extras appear only if source has them)
    const OSIS_BOOKS = [
      'Gen','Exod','Lev','Num','Deut','Josh','Judg','Ruth','1Sam','2Sam','1Kgs','2Kgs','1Chr','2Chr','Ezra','Neh','Tob','Jdt','Esth','1Macc','2Macc',
      'Job','Ps','Prov','Eccl','Song','Wis','Sir','Isa','Jer','Lam','Bar','EpJer','Ezek','Dan','Hos','Joel','Amos','Obad','Jonah','Mic','Nah','Hab','Zeph','Hag','Zech','Mal',
      'Matt','Mark','Luke','John','Acts','Rom','1Cor','2Cor','Gal','Eph','Phil','Col','1Thess','2Thess','1Tim','2Tim','Titus','Phlm','Heb','Jas','1Pet','2Pet','1John','2John','3John','Jude','Rev',
      'Sus','Bel','PrAzar','SgThree'
    ];

    // --- DOM ---
    const verseEl   = document.getElementById('verse');
    const sourceEl  = document.getElementById('source');
    const statusEl  = document.getElementById('status');
    const randomBtn = document.getElementById('random-verse');
    const stopBtn   = document.getElementById('stop-tts');
    const langSelect= document.getElementById('lang-select');
    const bookSelect    = document.getElementById('book-select');
    const chapterSelect = document.getElementById('chapter-select');
    const verseSelect   = document.getElementById('verse-select');
    const goVerseBtn    = document.getElementById('go-verse');
    const nextVerseBtn  = document.getElementById('next-verse');
    const refInput      = document.getElementById('ref-input');
    const goRefBtn      = document.getElementById('go-ref');
    const autoBtn       = document.getElementById('auto-toggle');
    const autoPauseBtn  = document.getElementById('auto-pause');
    const rateInput     = document.getElementById('rate');
    const rateVal       = document.getElementById('rate-val');
    const customEnInput = document.getElementById('custom-en-url');
    const useCustomBtn  = document.getElementById('use-custom-en');

    // --- State ---
    const versesCache = { en: [], jp: [] };
    const indexCache  = { en: null, jp: null };
    let currentOsisId = null;
    let autoOn=false, autoPaused=false, currentUtterance=null;

    // --- Helpers ---
    const normalizeOsis = id => id?.split('!')[0]?.split('-')[0] || id;
    const showStatus = t => statusEl.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>${t}`;
    const warnStatus = t => statusEl.innerHTML = `<span class="text-warning">⚠</span> ${t}`;
    const errorStatus= t => statusEl.innerHTML = `<span class="text-danger">✖</span> ${t}`;
    const clearStatus= () => statusEl.textContent='';

    function enableAutoControls(on){
      autoBtn.disabled=!on; autoPauseBtn.disabled=!on;
      goVerseBtn.disabled=!on; nextVerseBtn.disabled=!on;
      bookSelect.disabled=!on; chapterSelect.disabled=!on; verseSelect.disabled=!on;
    }

    // --- Choose best English URL (GET probe) ---
    async function resolveEnglishURL(){
      // custom override
      const u = (customEnInput.value||'').trim();
      if (u) return u;

      const tryList = async (lst) => {
        for (const url of lst) {
          try {
            // Some hosts reject HEAD; do a lightweight GET
            const res = await fetch(url, { method:'GET', cache:'no-store', redirect:'follow' });
            if (res.ok) {
              const ct = (res.headers.get('content-type')||'').toLowerCase();
              // Simple sanity: expect xml and non-trivial length
              const text = await res.text();
              if (ct.includes('xml') && text.length > 2000) {
                return url;
              }
            }
          } catch(_) {}
        }
        return null;
      };

      let found = await tryList(EBIBLE_CANDIDATES_KJVD);
      if (found) return found;

      found = await tryList(EBIBLE_KJV_OSIS);
      if (found) {
        warnStatus('KJVD not found at eBible; using KJV from eBible.');
        return found;
      }

      warnStatus('eBible OSIS not reachable; falling back to GitHub KJV.');
      return LAST_RESORT_KJV;
    }

    // --- TTS ---
    function cancelOnly(){ if(window.speechSynthesis) window.speechSynthesis.cancel(); currentUtterance=null; }
    function abortTTS(){ cancelOnly(); autoOn=false; autoPaused=false; updateAutoUI(); }
    function speak(text,ttsLang,{onend}={}){
      cancelOnly(); if(!('speechSynthesis' in window)) return;
      const ut=new SpeechSynthesisUtterance(text); ut.lang=ttsLang; ut.rate=Number(rateInput.value)||1;
      ut.onend=()=>{ currentUtterance=null; if(typeof onend==='function') onend(); };
      ut.onerror=()=>{ currentUtterance=null; };
      const go=()=>{ window.speechSynthesis.speak(ut); currentUtterance=ut; };
      const v=window.speechSynthesis.getVoices(); if(!v||!v.length){ const once=()=>{window.speechSynthesis.removeEventListener('voiceschanged',once); go();}; window.speechSynthesis.addEventListener('voiceschanged',once); window.speechSynthesis.getVoices(); } else go();
    }

    // --- OSIS parsing ---
    function buildVersesFromOSIS(xmlDoc){
      const inline = Array.from(xmlDoc.getElementsByTagName('verse')).map(n=>({id:n.getAttribute('osisID'), text:(n.textContent||'').trim()})).filter(v=>v.id&&v.text);
      if(inline.length) return inline;
      const map=new Map(), stack=[]; const w=document.createTreeWalker(xmlDoc,NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT);
      const top=()=>stack.length?stack[stack.length-1]:null; let node=w.currentNode;
      while(node){
        if(node.nodeType===Node.ELEMENT_NODE){
          const el=node;
          if(el.tagName?.toLowerCase()==='verse'){
            const sID=el.getAttribute('sID'), eID=el.getAttribute('eID'), osisID=el.getAttribute('osisID');
            if(sID||osisID){ const id=osisID||sID; stack.push(id); if(!map.has(id)) map.set(id,[]); }
            if(eID){ let p; do{ p=stack.pop(); }while(p&&p!==eID&&stack.length); }
          }
        } else if(node.nodeType===Node.TEXT_NODE){
          const id=top(); if(id){ const t=node.nodeValue.replace(/\s+/g,' '); if(t.trim()) map.get(id).push(t); }
        }
        node=w.nextNode();
      }
      return Array.from(map.entries()).map(([id,chunks])=>({id,text:chunks.join('').replace(/\s+/g,' ').trim()})).filter(v=>v.id&&v.text);
    }

    // --- Load + cache ---
    async function loadVerses(lang){
      if(versesCache[lang]?.length) return;
      showStatus(SOURCES[lang].loading);
      try{
        if(lang==='en' && !SOURCES.en.url) SOURCES.en.url = await resolveEnglishURL();
        const res=await fetch(SOURCES[lang].url, { cache:'no-store', redirect:'follow' });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const xmlText=await res.text();
        const xmlDoc=new DOMParser().parseFromString(xmlText,'application/xml');
        const verses=buildVersesFromOSIS(xmlDoc);
        if(!verses.length) throw new Error('Parsed 0 verses');
        versesCache[lang]=verses;
        statusEl.innerHTML = `<span class="text-muted">Loaded: <code class="small">${SOURCES[lang].url}</code></span>`;
        clearStatus();
      }catch(e){ console.error(e); errorStatus(SOURCES[lang].error + ' ('+e.message+')'); versesCache[lang]=[]; }
    }

    function getById(lang, osisId){
      const list = versesCache[lang]||[];
      const base = normalizeOsis(osisId);
      return list.find(v => normalizeOsis(v.id)===base) || null;
    }

    // --- Index + selects ---
    async function ensureIndex(lang){
      if(indexCache[lang]) return;
      showStatus(lang==='jp'?'インデックス作成中…':'Building index…');
      const list=versesCache[lang]||[]; const idx={booksOrder:[],books:{}};
      for(const v of list){
        const base=normalizeOsis(v.id); const parts=base.split('.'); if(parts.length<3) continue;
        const [book,ch,vs]=parts;
        if(!idx.books[book]){ idx.books[book]={chaptersOrder:[],chapters:{}}; idx.booksOrder.push(book); }
        const b=idx.books[book];
        if(!b.chapters[ch]){ b.chapters[ch]={versesOrder:[],verses:{}}; b.chaptersOrder.push(ch); }
        const c=b.chapters[ch];
        if(!c.verses[vs]){ c.verses[vs]=base; c.versesOrder.push(vs); }
      }
      idx.booksOrder=OSIS_BOOKS.filter(b=>idx.books[b]);
      for(const book of idx.booksOrder){
        const b=idx.books[book];
        b.chaptersOrder.sort((a,b)=>Number(a)-Number(b));
        for(const ch of b.chaptersOrder){ b.chapters[ch].versesOrder.sort((a,b)=>Number(a)-Number(b)); }
      }
      indexCache[lang]=idx; clearStatus(); populateBookSelect(lang);
    }

    function populateBookSelect(lang){
      const idx=indexCache[lang];
      bookSelect.innerHTML='';
      const books=idx?.booksOrder||[];
      for(const osis of books){
        const opt=document.createElement('option'); opt.value=osis; opt.textContent=osis; bookSelect.appendChild(opt);
      }
      if(books.length){
        bookSelect.disabled=false; chapterSelect.disabled=false; verseSelect.disabled=false;
        goVerseBtn.disabled=false; nextVerseBtn.disabled=false;
        populateChapterSelect(lang,bookSelect.value);
      }
    }
    function populateChapterSelect(lang,book){
      const idx=indexCache[lang]; const b=idx?.books?.[book]; chapterSelect.innerHTML='';
      if(!b){ chapterSelect.disabled=true; verseSelect.disabled=true; return; }
      for(const ch of b.chaptersOrder){ const opt=document.createElement('option'); opt.value=ch; opt.textContent=ch; chapterSelect.appendChild(opt); }
      chapterSelect.selectedIndex=0; populateVerseSelect(lang,book,chapterSelect.value);
    }
    function populateVerseSelect(lang,book,ch){
      const idx=indexCache[lang]; const c=idx?.books?.[book]?.chapters?.[ch]; verseSelect.innerHTML='';
      if(!c){ verseSelect.disabled=true; return; }
      for(const vs of c.versesOrder){ const opt=document.createElement('option'); opt.value=vs; opt.textContent=vs; verseSelect.appendChild(opt); }
      verseSelect.selectedIndex=0; enableAutoControls(true);
    }

    // --- Render + actions ---
    function render(lang,verse){
      if(!verse) return;
      const sep = (lang==='jp') ? '　' : ' — ';
      verseEl.textContent = `${normalizeOsis(verse.id)}${sep}${verse.text}`;
      sourceEl.textContent = `Source: ${SOURCES[lang].label}`;
    }
    function renderAndSpeak(lang,verse){ render(lang,verse); speak(verse.text,SOURCES[lang].ttsLang,{onend:()=>{if(autoOn&&!autoPaused) setTimeout(readNextVerse,120);}}); }

    async function newRandomVerse(){
      const lang=langSelect.value; verseEl.textContent=SOURCES[lang].loading; sourceEl.textContent='';
      await initSelectors(lang);
      const idx=indexCache[lang]; const books=idx.booksOrder; if(!books.length){ errorStatus('No books available.'); return; }
      const b=books[Math.floor(Math.random()*books.length)];
      const chs=idx.books[b].chaptersOrder; const ch=chs[Math.floor(Math.random()*chs.length)];
      const vss=idx.books[b].chapters[ch].versesOrder; const vs=vss[Math.floor(Math.random()*vss.length)];
      currentOsisId=`${b}.${ch}.${vs}`;
      const verse=getById(lang,currentOsisId); renderAndSpeak(lang,verse);
      bookSelect.value=b; chapterSelect.value=ch; verseSelect.value=vs;
    }

    function readSelected(){
      const lang=langSelect.value;
      const osis = indexCache[lang]?.books?.[bookSelect.value]?.chapters?.[chapterSelect.value]?.verses?.[verseSelect.value];
      if(!osis) return;
      currentOsisId = normalizeOsis(osis);
      const verse=getById(lang,currentOsisId); if(!verse) return;
      renderAndSpeak(lang,verse);
    }

    function readNextVerse(){
      const lang=langSelect.value; if(!currentOsisId) return;
      const parts=normalizeOsis(currentOsisId).split('.'); if(parts.length<3) return;
      let [book, ch, vs] = [parts[0], Number(parts[1]), Number(parts[2])];
      const idx=indexCache[lang]; const b=idx?.books?.[book]; if(!b) return;
      const c=b.chapters[ch]; if(!c) return;
      const pos=c.versesOrder.indexOf(String(vs));
      if(pos>=0 && pos<c.versesOrder.length-1) vs=c.versesOrder[pos+1];
      else{
        const chPos=b.chaptersOrder.indexOf(String(ch));
        if(chPos>=0 && chPos<b.chaptersOrder.length-1){ ch=Number(b.chaptersOrder[chPos+1]); vs=b.chapters[ch].versesOrder[0]; }
        else{
          const bPos=idx.booksOrder.indexOf(book);
          if(bPos>=0 && bPos<idx.booksOrder.length-1){ book=idx.booksOrder[bPos+1]; ch=Number(idx.books[book].chaptersOrder[0]); vs=idx.books[book].chapters[ch].versesOrder[0]; }
          else{ verseEl.textContent=(lang==='jp'?'聖書の最後まで読みました。':'Reached the end.'); autoOn=false; autoPaused=false; updateAutoUI(); return; }
        }
      }
      const osis=`${book}.${ch}.${vs}`; const verse=getById(lang, osis); if(!verse) return;
      currentOsisId=normalizeOsis(osis); renderAndSpeak(lang, verse);
      bookSelect.value=book; chapterSelect.value=String(ch); verseSelect.value=String(vs);
    }

    function updateAutoUI(){
      autoBtn.classList.toggle('btn-success', !autoOn);
      autoBtn.classList.toggle('btn-danger', autoOn);
      autoBtn.textContent = autoOn ? 'Auto-Play ■ Stop' : 'Auto-Play ▶';
      autoPauseBtn.textContent = autoPaused ? 'Resume ▶' : 'Pause ⏸';
      autoPauseBtn.classList.toggle('btn-warning', autoPaused);
      autoPauseBtn.classList.toggle('btn-outline-warning', !autoPaused);
    }
    function toggleAuto(){
      if(!currentOsisId){ verseEl.textContent=(langSelect.value==='jp'?'先に節を選んでください。':'Select or load a verse first.'); return; }
      autoOn=!autoOn;
      if(autoOn){
        autoPaused=false;
        const v=getById(langSelect.value, currentOsisId);
        if(v) speak(v.text, SOURCES[langSelect.value].ttsLang, { onend:()=>{ if(autoOn && !autoPaused) setTimeout(readNextVerse,120);} });
      }else abortTTS();
      updateAutoUI();
    }
    function togglePause(){
      if(!autoOn) return;
      autoPaused=!autoPaused;
      if(autoPaused){ if(currentUtterance) window.speechSynthesis.cancel(); currentUtterance=null; }
      else{
        const v=getById(langSelect.value, currentOsisId);
        if(v) speak(v.text, SOURCES[langSelect.value].ttsLang, { onend:()=>{ if(autoOn && !autoPaused) setTimeout(readNextVerse,120);} });
      }
      updateAutoUI();
    }

    async function initSelectors(lang){ await loadVerses(lang); await ensureIndex(lang); }

    async function goToReference(){
      const lang = langSelect.value;
      verseEl.textContent = SOURCES[lang].loading; sourceEl.textContent = '';
      try{
        await initSelectors(lang);
        const cleaned = refInput.value.trim().replace('：',':').replace(/\s+/g,' ');
        const m = cleaned.match(/^(.+?)\s+(\d+)\s*[:.]\s*(\d+)$/i);
        if(!m){ verseEl.textContent = (lang==='jp'?'参照の形式に誤りがあります。例: ヨハネ 3:16':'Could not parse reference. Try e.g., "Sirach 2:1".'); return; }
        const [_, book, ch, vs] = m;
        const idx=indexCache[lang];
        if(!idx.books[book] || !idx.books[book].chapters[ch] || !idx.books[book].chapters[ch].verses[vs]){
          verseEl.textContent = (lang==='jp'?'この版ではその箇所が見つかりませんでした。':'That verse was not found in this edition.');
          return;
        }
        const osis = idx.books[book].chapters[ch].verses[vs];
        currentOsisId = normalizeOsis(osis);
        const verse = getById(lang, currentOsisId);
        renderAndSpeak(lang, verse);
        bookSelect.value=book; chapterSelect.value=String(ch); verseSelect.value=String(vs);
        enableAutoControls(true);
      }catch(e){ console.error(e); errorStatus(SOURCES[lang].error); }
    }

    // Events
    randomBtn.addEventListener('click', newRandomVerse);
    stopBtn.addEventListener('click', abortTTS);
    goVerseBtn.addEventListener('click', readSelected);
    nextVerseBtn.addEventListener('click', readNextVerse);
    goRefBtn.addEventListener('click', goToReference);
    langSelect.addEventListener('change', async ()=>{
      abortTTS(); indexCache[langSelect.value]=null;
      try{ await initSelectors(langSelect.value); enableAutoControls(true);}catch(e){ console.error(e); errorStatus(SOURCES[langSelect.value].error); }
    });
    useCustomBtn.addEventListener('click', async ()=>{
      if(!customEnInput.value.trim()) return;
      SOURCES.en.url = null; // force re-resolve (will prefer custom)
      abortTTS(); indexCache.en=null; versesCache.en=[];
      langSelect.value='en';
      await initSelectors('en');
      enableAutoControls(true);
    });
    rateInput.addEventListener('input', ()=>{ rateVal.textContent = `${Number(rateInput.value).toFixed(1)}×`; });
    autoBtn.addEventListener('click', toggleAuto);
    autoPauseBtn.addEventListener('click', togglePause);

    // Bootstrap
    (async () => {
      try { await initSelectors(langSelect.value); enableAutoControls(true); }
      catch (e) { console.error(e); errorStatus(SOURCES[langSelect.value].error); }
      if ('speechSynthesis' in window) {
        try { window.speechSynthesis.getVoices(); setTimeout(()=>window.speechSynthesis.getVoices(), 0); } catch {}
      }
    })();
  </script>
</body>
</html>
