@page "/appflags"
@using Editor.WordPress
@using Microsoft.AspNetCore.WebUtilities
@using System.Net
@using Editor.Abstractions
@inject BlazorWP.Data.AppFlags Flags
@inject NavigationManager Navigation
@inject IWordPressApiService Api
@inject AppPasswordService AppPassService
@inject WpNonceJsInterop NonceJs
@inject IStringLocalizer<AppFlags> L
@implements IDisposable

<PageTitle>@L["Title"]</PageTitle>

<section aria-labelledby="appflags-heading" class="container py-3" data-testid="appflags-page">
    <h3 id="appflags-heading" class="mb-3">@L["Heading"]</h3>

    <div class="alert alert-light border" role="status" aria-live="polite" data-testid="state-panel">
        <div>@L["StateModeLabel"] <span data-testid="state-mode">@GetModeLabel(Flags.Mode)</span></div>
        <div>@L["StateAuthLabel"] <span data-testid="state-auth">@GetAuthLabel(Flags.Auth)</span></div>
        <div>@L["StateLanguageLabel"] <span data-testid="state-lang">@GetLanguageLabel(Flags.Language)</span></div>
        <div>@L["StateWpUrlLabel"] <span data-testid="state-wpurl">@Flags.WpUrl</span></div>
    </div>

    <table class="table table-striped" data-testid="flags-table">
        <thead>
            <tr>
                <th scope="col">@L["FeatureHeader"]</th>
                <th scope="col">@L["OptionsHeader"]</th>
            </tr>
        </thead>
        <tbody>
            <tr data-testid="row-appmode">
                <td><label id="appmode-label">@L["AppModeLabel"]</label></td>
                <td aria-labelledby="appmode-label">
                    @foreach (AppMode mode in Enum.GetValues<AppMode>())
                    {
                        var active = Flags.Mode == mode;
                        var url = BuildUrl("appmode", mode == AppMode.Basic ? "basic" : "full");
                        <button type="button" class="btn btn-sm me-1 @(active ? "btn-primary" : "btn-outline-secondary")"
                            role="button" aria-pressed="@active" data-testid="@($"appmode-{mode.ToString().ToLower()}")"
                            title="@L["SetAppModeTo", GetModeLabel(mode)]" @onclick="() => SetAppMode(mode, url)">
                            @GetModeLabel(mode)
                        </button>
                    }
                </td>
            </tr>
            <tr data-testid="row-authtype">
                <td><label id="authtype-label">@L["AuthTypeLabel"]</label></td>
                <td aria-labelledby="authtype-label">
                    @foreach (AuthType type in Enum.GetValues<AuthType>())
                    {
                        var active = Flags.Auth == type;
                        var url = BuildUrl("auth", type == AuthType.Nonce ? "nonce" : "apppass");
                        <button type="button" class="btn btn-sm me-1 @(active ? "btn-primary" : "btn-outline-secondary")"
                            role="button" aria-pressed="@active" data-testid="@($"auth-{type.ToString().ToLower()}")"
                            title="@L["SetAuthTo", GetAuthLabel(type)]" @onclick="() => SetAuth(type, url)">
                            @GetAuthLabel(type)
                        </button>
                    }
                </td>
            </tr>
            <tr data-testid="row-language">
                <td><label id="language-label">@L["LanguageLabel"]</label></td>
                <td aria-labelledby="language-label">
                    @foreach (Language lang in Enum.GetValues<Language>())
                    {
                        var active = Flags.Language == lang;
                        var url = BuildUrl("lang", lang == Language.Japanese ? "jp" : "en");
                        <button type="button" class="btn btn-sm me-1 @(active ? "btn-primary" : "btn-outline-secondary")"
                            role="button" aria-pressed="@active" data-testid="@($"lang-{lang.ToString().ToLower()}")"
                            title="@L["SetLanguageTo", GetLanguageLabel(lang)]" @onclick="() => SetLanguage(lang, url)">
                            @GetLanguageLabel(lang)
                        </button>
                    }
                </td>
            </tr>
            <tr data-testid="row-wpurl">
                <td>
                    <label for="wpurl-input">@L["WpUrlLabel"]</label>
                </td>
                <td>
                    <form @onsubmit="OnWpUrlSubmit" data-testid="wpurl-form">
                        <div class="input-group">
                            <input id="wpurl-input" class="form-control" placeholder="https://example.com" @bind="wpUrl"
                                @bind:event="oninput" data-testid="wpurl-input" />
                            <button type="submit" class="btn btn-primary" data-testid="wpurl-save">@L["SaveButton"]</button>
                        </div>
                        <div class="form-text">
                            @((MarkupString)L["WpUrlHint"].Value)
                        </div>
                    </form>
                </td>
            </tr>
        </tbody>
    </table>

    <!-- Quick Check -->
    <div class="card mt-4" data-testid="wpdi-card">
        <div class="card-body">
            <h5 class="card-title mb-3">@L["QuickCheckTitle"]</h5>
            <div class="row g-2 align-items-center mb-2">
                <div class="col-auto">@L["QuickCheckAuthLabel"]</div>
                <div class="col-auto"><span class="badge bg-info" data-testid="wpdi-auth">@GetAuthLabel(Flags.Auth)</span></div>
            </div>
            <div class="mb-2">
                <strong>@L["StatusLabel"]</strong>
                <span data-testid="wpdi-status">@(_checkStatus ?? L["IdleStatus"].Value)</span>
                @if (_httpCode is not null)
                {
                    <span class="text-muted" data-testid="wpdi-code"> (@_httpCode)</span>
                }
                @if (!string.IsNullOrWhiteSpace(_userName))
                {
                    <span class="ms-2" data-testid="wpdi-user">@L["UserLabel"] @_userName</span>
                }
                @if (!string.IsNullOrWhiteSpace(_error))
                {
                    <div class="text-danger small mt-1" data-testid="wpdi-error">@_error</div>
                }
                @if (_lastChecked is not null)
                {
                    <div class="text-muted small" data-testid="wpdi-last">@L["LastLabel"] @_lastChecked</div>
                }
            </div>
            <button class="btn btn-outline-primary btn-sm" data-testid="wpdi-run" disabled="@_checking"
                @onclick="RunQuickCheck">
                @(_checking ? L["CheckingEllipsis"] : L["RunCheck"])
            </button>
        </div>
    </div>
</section>

<!-- Auth Scenarios Lab -->
<div class="card mt-4" data-testid="authlab-card">
    <div class="card-body">
        <h5 class="card-title mb-3">@L["AuthLabTitle"]</h5>

        <div class="mb-2 text-muted small">
            @((MarkupString)L["AuthLabDescription"].Value)
        </div>

        <div class="row g-2 align-items-end mb-2">
            <div class="col-sm-4">
                <label for="authlab-user" class="form-label">@L["AppPassUsernameLabel"]</label>
                <input id="authlab-user" class="form-control" @bind="_appUser" data-testid="authlab-user" />
            </div>
            <div class="col-sm-4">
                <label for="authlab-pass" class="form-label">@L["AppPassPasswordLabel"]</label>
                <input id="authlab-pass" type="password" class="form-control" @bind="_appPass"
                    data-testid="authlab-pass" />
            </div>
            <div class="col-sm-4 d-flex gap-2">
                <button class="btn btn-primary" data-testid="authlab-save-valid" @onclick="SaveValidAppPass"
                    disabled="@(_saving)">@L["SaveAppPassButton"]</button>
                <button class="btn btn-outline-danger" data-testid="authlab-save-invalid" @onclick="SaveInvalidAppPass"
                    disabled="@(_saving)">@L["SaveInvalidButton"]</button>
                <button class="btn btn-outline-secondary" data-testid="authlab-clear" @onclick="ClearAppPass"
                    disabled="@(_saving)">@L["ClearButton"]</button>
            </div>
        </div>

        <div class="d-flex flex-wrap gap-2 mb-2">
            <button class="btn btn-outline-primary btn-sm" data-testid="authlab-open-login" @onclick="OpenWpLogin">@L["OpenWpLoginButton"]</button>
            <button class="btn btn-outline-secondary btn-sm" data-testid="authlab-open-admin"
                @onclick="OpenWpAdmin">@L["OpenWpAdminButton"]</button>
            <button class="btn btn-outline-dark btn-sm" data-testid="authlab-rebuild"
                @onclick="ForceRebuildClient">@L["ForceRebuildButton"]</button>
        </div>

        <div class="small">
            <div>@L["CredsPresentLabel"] <strong data-testid="authlab-creds-present">@(_credsPresent ? L["Yes"] : L["No"])</strong>
                @if (_credsPresent)
                {
                    <span class="ms-2 text-muted" data-testid="authlab-creds-mask">(@_credsMask)</span>
                }
            </div>
            <div class="text-muted">@((MarkupString)L["AuthLabTip"].Value)</div>
            @if (!string.IsNullOrEmpty(_authlabStatus))
            {
                <div class="mt-2" data-testid="authlab-status">@_authlabStatus</div>
            }
        </div>
    </div>
</div>

@code {
    private string wpUrl = string.Empty;

    // --- WPDI Quick Check state ---
    private bool _checking;
    private string? _checkStatus; // Idle | OK | Unauthorized | NotConfigured | Error
    private int? _httpCode;
    private string? _userName;
    private string? _error;
    private DateTimeOffset? _lastChecked;

    // --- AuthLab state ---
    private string _appUser = string.Empty;
    private string _appPass = string.Empty;
    private bool _credsPresent;
    private string _credsMask = string.Empty;
    private bool _saving;
    private string? _authlabStatus;

    protected override void OnInitialized()
    {
        wpUrl = Flags.WpUrl;
        Flags.OnChange += OnFlagsChanged;
        _ = InvokeAsync(async () =>
        {
            await LoadCredsPreview();
            await RunQuickCheck();
        });
    }

    private async Task LoadCredsPreview()
    {
        var creds = await AppPassService.GetAsync();
        _credsPresent = creds.HasValue;
        if (creds.HasValue)
        {
            var (u, p) = (creds.Value.Username ?? "", creds.Value.AppPassword ?? "");
            _appUser = string.IsNullOrEmpty(_appUser) ? u : _appUser;
            _credsMask = string.IsNullOrEmpty(p) ? L["EmptyMask"] : (p.Length <= 4 ? new string('*', p.Length) : new string('*', p.Length - 4) + p[^4..]);
        }
        else
        {
            _credsMask = string.Empty;
        }
        StateHasChanged();
    }

    private void OnFlagsChanged()
    {
        _ = InvokeAsync(async () => { await RunQuickCheck(); });
        StateHasChanged();
    }

    private string BuildUrl(string key, string value)
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        var dict = new Dictionary<string, string?>(StringComparer.OrdinalIgnoreCase);

        foreach (var kvp in query) dict[kvp.Key] = kvp.Value.ToString();
        dict["appmode"] = Flags.Mode == AppMode.Basic ? "basic" : "full";
        dict["auth"] = Flags.Auth == AuthType.Nonce ? "nonce" : "apppass";
        dict["lang"] = Flags.Language == Language.Japanese ? "jp" : "en";
        dict["wpurl"] = Flags.WpUrl;
        dict[key] = value;
        return QueryHelpers.AddQueryString(uri.GetLeftPart(UriPartial.Path), dict);
    }

    private async Task SetAppMode(AppMode mode, string url)
    {
        await Flags.SetAppMode(mode);
        Navigation.NavigateTo(url);
    }

    private async Task SetAuth(AuthType type, string url)
    {
        await Flags.SetAuthMode(type);
        if (type == AuthType.Nonce)
        {
            Api.SetAuthPreference(WordPressAuthPreference.Nonce(() => NonceJs.GetNonceAsync()));
        }
        else
        {
            var creds = await AppPassService.GetAsync();
            if (creds is { Username: var user, AppPassword: var pass })
            {
                Api.SetAuthPreference(WordPressAuthPreference.AppPassword(user, pass));
            }
            else
            {
                Api.SetAuthPreference(WordPressAuthPreference.None);
            }
        }
        Navigation.NavigateTo(url);
    }

    private async Task SetLanguage(Language lang, string url)
    {
        await Flags.SetLanguage(lang);
        Navigation.NavigateTo(url, forceLoad: true);
    }

    // Apply WP URL only on Save/Enter.
    private async Task OnWpUrlSubmit()
    {
        var url = BuildUrl("wpurl", wpUrl);
        await Flags.SetWpUrl(wpUrl);
        if (!string.IsNullOrWhiteSpace(wpUrl))
        {
            Api.SetEndpoint(wpUrl);
        }
        Navigation.NavigateTo(url);
    }

    private async Task RunQuickCheck()
    {
        _checking = true;
        _checkStatus = L["CheckingStatus"];
        _error = null; _userName = null; _httpCode = null;
        StateHasChanged();

        try
        {
            // Deterministic pre-check for AppPass mode: no creds → Unauthorized without network
            if (Flags.Auth == AuthType.AppPass)
            {
                var creds = await AppPassService.GetAsync();
                if (!creds.HasValue
                    || string.IsNullOrWhiteSpace(creds.Value.Username)
                    || string.IsNullOrWhiteSpace(creds.Value.AppPassword))
                {
                    _checkStatus = L["UnauthorizedStatus"];
                    _httpCode = (int)HttpStatusCode.Unauthorized;
                    return;
                }
            }

            // Call the domain service (Option A). It uses our managed HttpClient + handlers.
            var me = await Api.GetCurrentUserAsync();
            _checkStatus = L["OkStatus"];
            _userName = me?.Name ?? me?.Username;
        }
        catch (AuthError ae)
        {
            _httpCode = (int)ae.StatusCode;
            _checkStatus = L["UnauthorizedStatus"];
            _error = ae.Message;
        }
        catch (RateLimited rl)
        {
            _httpCode = 429;
            _checkStatus = string.Format(L["HttpStatus"].Value, 429);
            _error = rl.RetryAfter is { } ra ? string.Format(L["TooManyRequestsWithRetry"].Value, ra) : L["TooManyRequests"].Value;
        }
        catch (TimeoutError te)
        {
            _checkStatus = L["ErrorStatus"];
            _error = te.Message;
        }
        catch (TransientHttpError th)
        {
            _httpCode = th.StatusCode is { } sc ? (int)sc : null;
            _checkStatus = th.StatusCode is { } sc2 ? string.Format(L["HttpStatus"].Value, (int)sc2) : L["ErrorStatus"].Value;
            _error = th.Message;
        }
        catch (UnexpectedHttpError uh)
        {
            _httpCode = (int)uh.StatusCode;
            _checkStatus = string.Format(L["HttpStatus"].Value, _httpCode);
            _error = uh.Message;
        }
        catch (Exception ex)
        {
            // 5xx and raw transport may still bubble HttpRequestException from PolicyHandler tests → show generic Error
            _checkStatus = L["ErrorStatus"];
            _error = ex.Message;
        }
        finally
        {
            _lastChecked = DateTimeOffset.Now;
            _checking = false;
            StateHasChanged();
        }
    }

    private async Task SaveValidAppPass()
    {
        _saving = true; _authlabStatus = null; StateHasChanged();
        try
        {
            if (string.IsNullOrWhiteSpace(_appUser) || string.IsNullOrWhiteSpace(_appPass))
            {
                _authlabStatus = L["AuthLabStatusMissingCreds"];
                return;
            }
            await AppPassService.SetAsync(_appUser, _appPass);
            _authlabStatus = L["AuthLabStatusSaved"];
            Api.SetAuthPreference(WordPressAuthPreference.AppPassword(_appUser, _appPass));
            await LoadCredsPreview();
            await RunQuickCheck();
        }
        finally { _saving = false; StateHasChanged(); }
    }

    private async Task SaveInvalidAppPass()
    {
        _saving = true; _authlabStatus = null; StateHasChanged();
        try
        {
            if (string.IsNullOrWhiteSpace(_appUser) || string.IsNullOrWhiteSpace(_appPass))
            {
                _authlabStatus = L["AuthLabStatusMissingInvalid"];
                return;
            }
            var wrong = _appPass + "-wrong";
            await AppPassService.SetAsync(_appUser, wrong);
            _authlabStatus = L["AuthLabStatusSavedInvalid"];
            Api.SetAuthPreference(WordPressAuthPreference.AppPassword(_appUser, wrong));
            await LoadCredsPreview();
            await RunQuickCheck();
        }
        finally { _saving = false; StateHasChanged(); }
    }

    private async Task ClearAppPass()
    {
        _saving = true; _authlabStatus = null; StateHasChanged();
        try
        {
            await AppPassService.ClearAsync();
            _authlabStatus = L["AuthLabStatusCleared"];
            Api.SetAuthPreference(WordPressAuthPreference.None);
            await LoadCredsPreview();
            await RunQuickCheck();
        }
        finally { _saving = false; StateHasChanged(); }
    }

    private void OpenWpLogin()
    {
        var target = string.IsNullOrWhiteSpace(Flags.WpUrl) ? null : Flags.WpUrl.TrimEnd('/') + "/wp-login.php";
        if (!string.IsNullOrEmpty(target)) Navigation.NavigateTo(target, forceLoad: true);
    }

    private void OpenWpAdmin()
    {
        var target = string.IsNullOrWhiteSpace(Flags.WpUrl) ? null : Flags.WpUrl.TrimEnd('/') + "/wp-admin/";
        if (!string.IsNullOrEmpty(target)) Navigation.NavigateTo(target, forceLoad: true);
    }

    private async Task ForceRebuildClient()
    {
        await Api.GetClientAsync(); // trigger lazy init without UI setting endpoint
        await RunQuickCheck();
    }

    public void Dispose() => Flags.OnChange -= OnFlagsChanged;

    private string GetModeLabel(AppMode mode) => L[$"AppMode_{mode}"];
    private string GetAuthLabel(AuthType type) => L[$"AuthType_{type}"];
    private string GetLanguageLabel(Language lang) => L[$"Language_{lang}"];
}
