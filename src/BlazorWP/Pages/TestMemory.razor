@page "/test-memory"
@inject BlazorWP.Data.ILocalStore LocalStore
@inject IStringLocalizer<TestMemory> L

<PageTitle>@L["Title"]</PageTitle>

<h3>@L["Heading"]</h3>

<input id="title" data-testid="title-input" @bind="title" />

<button id="add" data-testid="btn-add" @onclick="Add">@L["AddButton"]</button>
<button id="put" data-testid="btn-put" @onclick="Put">@L["PutButton"]</button>
<button id="get" data-testid="btn-get" @onclick="GetById">@L["GetButton"]</button>
<button id="list" data-testid="btn-list" @onclick="ListAll">@L["ListButton"]</button>
<button id="delete" data-testid="btn-delete" @onclick="Delete">@L["DeleteButton"]</button>

<!-- NEW: single button that triggers two concurrent adds with distinct payloads -->
<button id="add-race" data-testid="btn-add-race" @onclick="AddRaceCombined">@L["AddRaceButton"]</button>

<p id="status" data-testid="status" role="status" aria-live="polite">@status</p>

<ul id="drafts" data-testid="draft-list">
  @foreach (var draft in drafts)
  {
    <li data-testid="draft-item">
      <span data-testid="draft-id">@draft.id</span>
      <span data-testid="draft-title">@draft.Title</span>
    </li>
  }
</ul>

@code {
    private const string STORE = "kv";  // generic KV store (id is string)
    private string title = "";
    private string status = "";
    private List<Draft> drafts = new();

    // KV contract: primary key field is lowercase "id" and is a string
    private class Draft
    {
        public string id { get; set; } = "";
        public string Title { get; set; } = "";
    }

    private async Task Add()
    {
        var key = $"draft:{Guid.NewGuid():N}";
        await LocalStore.PutAsync(STORE, new Draft { id = key, Title = title }); // upsert acts as insert
        status = string.Format(L["StatusAdded"].Value, key);
    }

    private async Task Put()
    {
        const string key = "draft:1";
        await LocalStore.PutAsync(STORE, new Draft { id = key, Title = title }); // upsert fixed id
        status = L["StatusPut"].Value;
    }

    private async Task GetById()
    {
        const string key = "draft:1";
        var result = await LocalStore.GetByKeyAsync<Draft>(STORE, key);
        status = result?.Title ?? L["StatusNotFound"].Value;
    }

    private async Task ListAll()
    {
        drafts = (await LocalStore.GetAllAsync<Draft>(STORE)).ToList();
        status = string.Format(L["StatusListed"].Value, drafts.Count);
    }

    private async Task Delete()
    {
        const string key = "draft:1";
        await LocalStore.DeleteAsync(STORE, key);
        status = L["StatusDeleted"].Value;
    }

    // --- NEW: deterministic internal "race" ---

    private async Task AddRaceCombined()
    {
        // Fire two concurrent writes with distinct payloads.
        // Small stagger to encourage interleaving; ordering is irrelevant.
        var t1 = AddWithPayloadAsync(L["PayloadQuickAlpha"].Value, 30);
        var t2 = AddWithPayloadAsync(L["PayloadQuickBeta"].Value,  0);
        await Task.WhenAll(t1, t2);
    }

    private async Task AddWithPayloadAsync(string payloadTitle, int delayMs)
    {
        if (delayMs > 0)
            await Task.Delay(delayMs);

        var key = $"draft:{Guid.NewGuid():N}";
        await LocalStore.PutAsync(STORE, new Draft { id = key, Title = payloadTitle });
        status = string.Format(L["StatusAdded"].Value, key);
    }
}
